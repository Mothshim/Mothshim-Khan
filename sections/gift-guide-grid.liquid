{{ 'gift-guide.css' | asset_url | stylesheet_tag }}

{%- if section.settings.quick_add == 'standard' -%}
  <script src="{{ 'product-form.js' | asset_url }}" defer="defer"></script>
{%- endif -%}

<script src="{{ 'gift-guide.js' | asset_url }}" defer="defer"></script>

{%- style -%}
  .section-{{ section.id }}-padding {
    padding-top: {{ section.settings.padding_top | times: 0.75 | divided_by: 16.0 }}rem;
    padding-bottom: {{ section.settings.padding_bottom | times: 0.75 | divided_by: 16.0 }}rem;
  }

  @media screen and (min-width: 750px) {
    .section-{{ section.id }}-padding {
      padding-top: {{ section.settings.padding_top | divided_by: 16.0 }}rem;
      padding-bottom: {{ section.settings.padding_bottom | divided_by: 16.0 }}rem;
    }
  }
{%- endstyle -%}

<!-- Gift Guide Grid Section -->
<div class="color-{{ section.settings.color_scheme }} gradient">
  <div
    class="gift-grid section-{{ section.id }}-padding{% if section.settings.full_width %} gift-grid--full-width{% endif %}"
    id="gift-guide-products"
    style="--heading-align-mobile: {{ section.settings.heading_align_mobile }}; --heading-align-desktop: {{ section.settings.heading_align_desktop }};"
  >
    {%- if section.settings.title != blank -%}
      <h2 class="gift-grid__title {{ section.settings.heading_size }}">
        {{ section.settings.title }}
      </h2>
    {%- endif -%}

    <div
      class="gift-grid__container"
      style="
        --grid-desktop-columns: {{ section.settings.columns_desktop }};
        --grid-mobile-columns: {{ section.settings.columns_mobile }};
        --grid-gap: {{ section.settings.gap | divided_by: 16.0 }}rem;
        --mobile-btn-top: {{ section.settings.mobile_button_top }}rem;
        --mobile-btn-right: {{ section.settings.mobile_button_right }}rem;
        --btn-size: {{ section.settings.mobile_button_size }}rem;
        --desktop-btn-size: {{ section.settings.desktop_button_size }}rem;
      "
    >
      {%- for block in section.blocks -%}
        {%- assign product = block.settings.product -%}

        <div class="gift-grid__item" {{ block.shopify_attributes }}>
          {%- if product != blank -%}
            {%- liquid
              assign ratio = 1
              if section.settings.image_ratio == 'portrait'
                assign ratio = 0.8
              elsif section.settings.image_ratio == 'adapt' and product.featured_image
                assign ratio = product.featured_image.aspect_ratio
              endif
            -%}

            <div class="gift-grid__card">
              <div class="gift-grid__image-wrapper" style="--ratio-percent: {{ 1 | divided_by: ratio | times: 100 }}%;">
                {%- if product.featured_image -%}
                  <img
                    src="{{ product.featured_image | image_url: width: 600 }}"
                    srcset="
                      {{ product.featured_image | image_url: width: 165 }} 165w,
                      {{ product.featured_image | image_url: width: 360 }} 360w,
                      {{ product.featured_image | image_url: width: 533 }} 533w,
                      {{ product.featured_image | image_url: width: 720 }} 720w
                    "
                    sizes="(min-width: 750px) calc(100vw / {{ section.settings.columns_desktop }}), calc(100vw / {{ section.settings.columns_mobile }})"
                    alt="{{ product.featured_image.alt | default: product.title | escape }}"
                    class="gift-grid__image"
                    loading="lazy"
                    width="{{ product.featured_image.width }}"
                    height="{{ product.featured_image.height }}"
                  >
                {%- else -%}
                  {{ 'product-1' | placeholder_svg_tag: 'gift-grid__placeholder-svg' }}
                {%- endif -%}

                {%- if section.settings.quick_add == 'standard' -%}
                  {%- liquid
                    assign product_form_id = 'quick-add-' | append: section.id | append: product.id
                    assign qty_rules = false
                    if product.selected_or_first_available_variant.quantity_rule.min > 1 or product.selected_or_first_available_variant.quantity_rule.max != null or product.selected_or_first_available_variant.quantity_rule.increment > 1
                      assign qty_rules = true
                    endif
                  -%}

                  {%- if product.variants_count > 1 or qty_rules -%}
                    {%- comment -%} Multi-variant: open custom popup instantly {%- endcomment -%}
                    <button
                      type="button"
                      class="gift-grid__plus-btn"
                      aria-label="{{ 'products.product.choose_options' | t }}"
                      data-product-id="{{ product.id }}"
                      style="--btn-top: {{ block.settings.button_top }}rem; --btn-right: {{ block.settings.button_right }}rem;"
                    >
                      <svg class="gift-grid__plus-icon" width="30" height="30" viewBox="0 0 30 30" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                        <g filter="url(#filter-plus-{{ block.id }})">
                          <circle cx="15" cy="12" r="11" fill="#F8F8F8" fill-opacity="0.9"/>
                          <path d="M15.3457 8.04175V16.5033" stroke="black" stroke-width="1.5" stroke-linecap="square" stroke-linejoin="round"/>
                          <path d="M11.1152 12.2725H19.5768" stroke="black" stroke-width="1.5" stroke-linecap="square" stroke-linejoin="round"/>
                        </g>
                        <defs>
                          <filter id="filter-plus-{{ block.id }}" x="0" y="0" width="30" height="30" filterUnits="userSpaceOnUse" color-interpolation-filters="sRGB">
                            <feFlood flood-opacity="0" result="BackgroundImageFix"/>
                            <feColorMatrix in="SourceAlpha" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 127 0" result="hardAlpha"/>
                            <feOffset dy="3"/>
                            <feGaussianBlur stdDeviation="2"/>
                            <feComposite in2="hardAlpha" operator="out"/>
                            <feColorMatrix type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0.2 0"/>
                            <feBlend mode="normal" in2="BackgroundImageFix" result="effect1_dropShadow"/>
                            <feBlend mode="normal" in="SourceGraphic" in2="effect1_dropShadow" result="shape"/>
                          </filter>
                        </defs>
                      </svg>
                    </button>

                  {%- else -%}
                    {%- comment -%} Single variant: direct add to cart (Dawn pattern) {%- endcomment -%}
                    {%- assign variant = product.selected_or_first_available_variant -%}
                    <product-form data-section-id="{{ section.id }}">
                      {%- form 'product', product, id: product_form_id, class: 'form', novalidate: 'novalidate', data-type: 'add-to-cart-form' -%}
                        <input
                          type="hidden"
                          name="id"
                          value="{{ variant.id }}"
                          class="product-variant-id"
                          {% if variant.available == false %}disabled{% endif %}
                        >
                        <button
                          id="{{ product_form_id }}-submit"
                          type="submit"
                          name="add"
                          class="gift-grid__plus-btn"
                          aria-label="{{ 'products.product.add_to_cart' | t }}"
                          {% if variant.available == false %}disabled{% endif %}
                          style="--btn-top: {{ block.settings.button_top }}rem; --btn-right: {{ block.settings.button_right }}rem;"
                        >
                          <svg class="gift-grid__plus-icon" width="30" height="30" viewBox="0 0 30 30" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                            <g filter="url(#filter-plus-single-{{ block.id }})">
                              <circle cx="15" cy="12" r="11" fill="#F8F8F8" fill-opacity="0.9"/>
                              <path d="M15.3457 8.04175V16.5033" stroke="black" stroke-width="1.5" stroke-linecap="square" stroke-linejoin="round"/>
                              <path d="M11.1152 12.2725H19.5768" stroke="black" stroke-width="1.5" stroke-linecap="square" stroke-linejoin="round"/>
                            </g>
                            <defs>
                              <filter id="filter-plus-single-{{ block.id }}" x="0" y="0" width="30" height="30" filterUnits="userSpaceOnUse" color-interpolation-filters="sRGB">
                                <feFlood flood-opacity="0" result="BackgroundImageFix"/>
                                <feColorMatrix in="SourceAlpha" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 127 0" result="hardAlpha"/>
                                <feOffset dy="3"/>
                                <feGaussianBlur stdDeviation="2"/>
                                <feComposite in2="hardAlpha" operator="out"/>
                                <feColorMatrix type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0.2 0"/>
                                <feBlend mode="normal" in2="BackgroundImageFix" result="effect1_dropShadow"/>
                                <feBlend mode="normal" in="SourceGraphic" in2="effect1_dropShadow" result="shape"/>
                              </filter>
                            </defs>
                          </svg>
                          {%- render 'loading-spinner' -%}
                        </button>
                      {%- endform -%}
                    </product-form>
                  {%- endif -%}
                {%- endif -%}
              </div>
            </div>

          {%- else -%}
            <!-- Placeholder when no product selected -->
            <div class="gift-grid__card">
              <div class="gift-grid__image-wrapper" style="--ratio-percent: 100%;">
                {{ 'product-1' | placeholder_svg_tag: 'gift-grid__placeholder-svg' }}
              </div>
            </div>
          {%- endif -%}
        </div>
      {%- endfor -%}
    </div>
  </div>
</div>

{%- comment -%}
  Product JSON data in script tags â€” manually constructed.
  {{ product | json }} outputs an unexpected format (array with numeric keys),
  so we build the JSON explicitly with only the properties we need.
{%- endcomment -%}
{%- for block in section.blocks -%}
  {%- assign product = block.settings.product -%}
  {%- if product != blank -%}
    {%- liquid
      assign needs_popup = false
      if product.variants_count > 1
        assign needs_popup = true
      endif
      if product.selected_or_first_available_variant.quantity_rule.min > 1 or product.selected_or_first_available_variant.quantity_rule.max != null or product.selected_or_first_available_variant.quantity_rule.increment > 1
        assign needs_popup = true
      endif
    -%}
    {%- if needs_popup -%}
      <script type="application/json" data-product-data="{{ product.id }}">
        {
          "id": {{ product.id | json }},
          "title": {{ product.title | json }},
          "price": {{ product.price }},
          "description": {{ product.description | json }},
          "featured_image": {% if product.featured_image %}{{ product.featured_image | image_url: width: 600 | json }}{% else %}""{% endif %},
          "images": [
            {%- for image in product.images -%}
              {{ image | image_url: width: 600 | json }}{%- unless forloop.last -%},{%- endunless -%}
            {%- endfor -%}
          ],
          "options": {{ product.options | json }},
          "variants": [
            {%- for variant in product.variants -%}
              {
                "id": {{ variant.id }},
                "title": {{ variant.title | json }},
                "price": {{ variant.price }},
                "available": {{ variant.available }},
                "options": {{ variant.options | json }}
              }{%- unless forloop.last -%},{%- endunless -%}
            {%- endfor -%}
          ]
        }
      </script>
    {%- endif -%}
  {%- endif -%}
{%- endfor -%}

<!-- Custom Product Popup (Figma design) -->
<div class="gift-popup__overlay" id="gift-popup-overlay" aria-hidden="true">
  <div class="gift-popup" role="dialog" aria-modal="true" aria-label="Product details">
    <button class="gift-popup__close" type="button" aria-label="Close popup">
      {{- 'icon-close.svg' | inline_asset_content -}}
    </button>

    <!-- Header: image + title/price/description side by side -->
    <div class="gift-popup__header">
      <div class="gift-popup__image-wrapper">
        <img class="gift-popup__image" src="" alt="" id="popup-image">
      </div>
      <div class="gift-popup__info">
        <h3 class="gift-popup__title" id="popup-title"></h3>
        <p class="gift-popup__price" id="popup-price"></p>
        <div class="gift-popup__description" id="popup-description"></div>
      </div>
    </div>

    <!-- Variant options rendered dynamically by JS -->
    <div class="gift-popup__variants" id="popup-variants"></div>

    <!-- Add to cart button -->
    <button class="gift-popup__add-to-cart" type="button" id="popup-add-to-cart">
      <span class="gift-popup__add-to-cart-text">ADD TO CART</span>
      <span class="gift-popup__add-to-cart-arrow" aria-hidden="true">
        <svg width="29" height="12" viewBox="0 0 29 12" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M0.75 4.77298L6.72657e-08 4.77298L-6.72657e-08 6.27298L0.75 6.27298L0.75 4.77298ZM28.6378 6.05331C28.9307 5.76042 28.9307 5.28555 28.6378 4.99265L23.8649 0.219681C23.572 -0.0732126 23.0971 -0.0732126 22.8042 0.219681C22.5113 0.512574 22.5113 0.987448 22.8042 1.28034L27.0469 5.52298L22.8042 9.76562C22.5113 10.0585 22.5113 10.5334 22.8042 10.8263C23.0971 11.1192 23.572 11.1192 23.8649 10.8263L28.6378 6.05331ZM0.75 6.27298L28.1075 6.27298L28.1075 4.77298L0.75 4.77298L0.75 6.27298Z" fill="currentColor"/></svg>
      </span>
    </button>

    <!-- Feedback message -->
    <p class="gift-popup__feedback" id="popup-feedback" aria-live="polite"></p>
  </div>
</div>

{%- comment -%}
  Auto-add product data for conditional cart logic.
  When a product with Black + Medium variant is added, this product is auto-added too.
  Selected via "Auto-add product" setting in the section customizer.
{%- endcomment -%}
{%- assign jacket_product = section.settings.auto_add_product -%}
<script type="application/json" id="soft-winter-jacket-data">
  {%- if jacket_product != blank -%}
    {
      "id": {{ jacket_product.id | json }},
      "title": {{ jacket_product.title | json }},
      "variants": [
        {%- for variant in jacket_product.variants -%}
          {
            "id": {{ variant.id }},
            "title": {{ variant.title | json }},
            "available": {{ variant.available }}
          }{%- unless forloop.last -%},{%- endunless -%}
        {%- endfor -%}
      ]
    }
  {%- else -%}
    null
  {%- endif -%}
</script>

{% schema %}
{
  "name": "Gift Guide Grid",
  "tag": "section",
  "class": "section",
  "settings": [
    {
      "type": "header",
      "content": "General"
    },
    {
      "type": "inline_richtext",
      "id": "title",
      "label": "Heading",
      "default": "Tisso vison in the wild"
    },
    {
      "type": "select",
      "id": "heading_size",
      "options": [
        { "value": "h2", "label": "Small" },
        { "value": "h1", "label": "Medium" },
        { "value": "h0", "label": "Large" }
      ],
      "default": "h1",
      "label": "Heading size"
    },
    {
      "type": "checkbox",
      "id": "full_width",
      "label": "Make products full width",
      "default": false
    },
    {
      "type": "color_scheme",
      "id": "color_scheme",
      "label": "Color scheme",
      "default": "scheme-1"
    },
    {
      "type": "select",
      "id": "image_ratio",
      "options": [
        { "value": "adapt", "label": "Adapt to image" },
        { "value": "portrait", "label": "Portrait" },
        { "value": "square", "label": "Square" }
      ],
      "default": "square",
      "label": "Image ratio"
    },
    {
      "type": "select",
      "id": "quick_add",
      "options": [
        { "value": "none", "label": "None" },
        { "value": "standard", "label": "Standard" }
      ],
      "default": "standard",
      "label": "Quick add"
    },
    {
      "type": "range",
      "id": "gap",
      "min": 0,
      "max": 40,
      "step": 2,
      "unit": "px",
      "label": "Gap between products",
      "default": 2
    },
    {
      "type": "header",
      "content": "Desktop layout"
    },
    {
      "type": "select",
      "id": "columns_desktop",
      "options": [
        { "value": "2", "label": "2 columns" },
        { "value": "3", "label": "3 columns" },
        { "value": "4", "label": "4 columns" }
      ],
      "default": "3",
      "label": "Number of columns"
    },
    {
      "type": "select",
      "id": "heading_align_desktop",
      "options": [
        { "value": "left", "label": "Left" },
        { "value": "center", "label": "Center" },
        { "value": "right", "label": "Right" }
      ],
      "default": "center",
      "label": "Heading alignment"
    },
    {
      "type": "range",
      "id": "desktop_button_size",
      "min": 1,
      "max": 6,
      "step": 1,
      "unit": "rem",
      "label": "Button size",
      "default": 3
    },
    {
      "type": "header",
      "content": "Mobile layout"
    },
    {
      "type": "select",
      "id": "columns_mobile",
      "options": [
        { "value": "1", "label": "1 column" },
        { "value": "2", "label": "2 columns" }
      ],
      "default": "2",
      "label": "Number of columns"
    },
    {
      "type": "select",
      "id": "heading_align_mobile",
      "options": [
        { "value": "left", "label": "Left" },
        { "value": "center", "label": "Center" },
        { "value": "right", "label": "Right" }
      ],
      "default": "center",
      "label": "Heading alignment"
    },
    {
      "type": "range",
      "id": "mobile_button_top",
      "min": 0,
      "max": 20,
      "step": 1,
      "unit": "rem",
      "label": "Button top",
      "default": 1
    },
    {
      "type": "range",
      "id": "mobile_button_right",
      "min": 0,
      "max": 20,
      "step": 1,
      "unit": "rem",
      "label": "Button right",
      "default": 1
    },
    {
      "type": "range",
      "id": "mobile_button_size",
      "min": 1,
      "max": 6,
      "step": 1,
      "unit": "rem",
      "label": "Button size",
      "default": 3
    },
    {
      "type": "header",
      "content": "Conditional cart logic"
    },
    {
      "type": "product",
      "id": "auto_add_product",
      "label": "Auto-add product (Black + Medium)"
    },
    {
      "type": "header",
      "content": "Section padding"
    },
    {
      "type": "range",
      "id": "padding_top",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "label": "Padding top",
      "default": 36
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "label": "Padding bottom",
      "default": 36
    }
  ],
  "blocks": [
    {
      "type": "product",
      "name": "Product",
      "limit": 6,
      "settings": [
        {
          "type": "product",
          "id": "product",
          "label": "Product"
        },
        {
          "type": "header",
          "content": "Button position (desktop)"
        },
        {
          "type": "range",
          "id": "button_top",
          "min": 0,
          "max": 30,
          "step": 1,
          "unit": "rem",
          "label": "Button top",
          "default": 6
        },
        {
          "type": "range",
          "id": "button_right",
          "min": 0,
          "max": 30,
          "step": 1,
          "unit": "rem",
          "label": "Button right",
          "default": 6
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Gift Guide Grid",
      "blocks": [
        { "type": "product", "settings": { "button_right": 10, "button_top": 15 } },
        { "type": "product", "settings": { "button_right": 4, "button_top": 14 } },
        { "type": "product", "settings": { "button_right": 5, "button_top": 10 } },
        { "type": "product", "settings": { "button_right": 7, "button_top": 5 } },
        { "type": "product", "settings": { "button_right": 13, "button_top": 7 } },
        { "type": "product", "settings": { "button_right": 10, "button_top": 6 } }
      ]
    }
  ]
}
{% endschema %}
